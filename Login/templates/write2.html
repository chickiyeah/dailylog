<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/reset.css">
    <link rel="stylesheet" href="../static/css/header2.css">
    <link rel="stylesheet" href="../static/css/write2.css">
    <title>DAILY LOG</title>

       <!-- 아이콘 -->
    <script src="https://kit.fontawesome.com/80a9730165.js" crossorigin="anonymous"></script>

    <!-- 파비콘 -->
    <link rel="shortcut icon" href="./static/assets/house.svg" type="image/x-icon">
    <link rel="icon" href="./static/assets/house.svg" type="image/x-icon">

</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        let uploading = false
        if(document.cookie.includes("id=")){
            login = true
            if(document.cookie.split("id=")[1].includes(";")){
                id = document.cookie.split("id=")[1].split(";")[0].replace(" ","")
            }else{
                id = document.cookie.split("id=")[1].replace(" ","")
            }
            let userinfo = ""
            $.ajax({
                url:"/User",
                method:"POST",
                data:{
                    id:id
                },
                success: function(response){
                    name = response.nickname
                    console.log(userinfo)
                                //목록 가져오기
                    $.ajax({
                        url:"/Write",
                        method:"POST",
                        data:{
                            "Author":id
                        },
                        success: function(response){
                            response.forEach(element => {
                                let now = new Date()

                                let year = now.getFullYear()
                                let month = now.getMonth()
                                let day = now.getDate()
                                let hours = now.getHours()+9
                                let minutes = now.getMinutes()
                                let seconds = now.getSeconds()

                                let nowdate = new Date(year, month, day, hours, minutes, seconds)

                                let chai = nowdate.getTime() - new Date(element.Created_At).getTime()
                                let a = ""

                                let wmon = new Date(element.Created_At).getUTCMonth()
                                let wday = new Date(element.Created_At).getDate()

                                if(chai < 1000 * 60)
                                    a += '방금'
                                else if(chai < 1000 * 60 * 60)
                                    a += Math.floor(chai / (1000 * 60)) + ' 분전';
                                else if(chai < 1000 * 60 * 60 * 24)
                                    a += Math.floor(chai / (1000 * 60 * 60)) + ' 시간전';
                                else if(chai < 1000 * 60 * 60 * 24 * 30)
                                    a += Math.floor(chai / (1000 * 60 * 60 * 24)) + ' 일전';
                                else if(chai < 1000 * 60 * 60 * 24 * 30 * 12)
                                    a += Math.floor(chai / (1000 * 60 * 60 * 24 * 30)) + ' 달전';
                                
                                addCard(wmon+"/"+wday, element.Description, name, a)
                            });
                        }
                    })
                }
            })

        }else{ 
            login = false
            location.href = "/Login?loc = write/2"
            alert("로그인이 필요합니다.")
        }
    })

    let link = []

    var openWin

    function openMap() {
        window.name = "글 작성";
        openWin = window.open("/write/popupmap", "장소를 선택해주세요.","width=870, height=880, resizable = no, scrollbars = no")
    }
    let uploading = false
    function upload() {
        if(uploading != false){
            alert("이미 글을 업로드 중입니다.")
        }else{
            
        
        ok = true
        if(document.getElementById("title").value == ''){
            ok = false
            $(".title").focus()
            alert('제목을 입력해주세요.')
            return
        }

        if(document.getElementById("maps").value == ''){
            ok = false
            $(".maps").focus()
            alert('지역을 입력해주세요.')
            //$(".map").attr('placeholder', '지역을 입력해주세요.')
            return
        }

        if(document.getElementById("todayuser").value == ''){
            ok = false
            $(".todayuser").focus()
            alert('오늘 만난 사람을 입력해주세요. 만난사람이 없는경우 없음 이라고 적어주세요.')
            return
        }

        if($("#select #option").text() == '오늘의 기분'){
            ok = false
            $("#select #option").focus()
            $("#select ul").toggle();
            alert("오늘의 기분을 선택해주세요.")
            return
        }

        if($("#select2 #option2").text() == '오늘의 메뉴'){
            ok = false
            $("#select2 #option2").focus()
            $("#select2 ul").toggle();
            alert("오늘의 메뉴를 선택해주세요.")
            return
        }

        if($("#textarea").val() == ''){
            ok = false
            $("#textarea").focus()
            alert("내용을 입력해주세요.")
            return
        }

        if(document.cookie.split("id=")[1].includes(";")){
                id = document.cookie.split("id=")[1].split(";")[0].replace(" ","")
            }else{
                id = document.cookie.split("id=")[1].replace(" ","")
        }
        uploading = true
        if(ok == true){
            if(document.getElementById("todayuser").value != "없음"){
                    ADR = document.cookie.split("adr=")[1].split(";")[0].replace(" ","")
                    LAT = document.cookie.split("LAT=")[1].split(";")[0].replace(" ","")
                    LNG = document.cookie.split("LNG=")[1].split(";")[0].replace(" ","")
                    !!document.cookie.includes("road_adr=") ? LOAD_ADR = document.cookie.split("road_adr=")[1].split(";")[0].replace(" ","") : LOAD_ADR = 'null'
                    !!document.cookie.includes("name=") ? NAME = document.cookie.split("name=")[1].split(";")[0].replace(" ","") : NAME = 'null'

                    json = {
                        'Author':id,
                        'Name': document.getElementById("title").value,
                        'Desc': document.getElementById("textarea").value,
                        'People_meet': document.getElementById("todayuser").value,
                        'Feel': $("#select #option").text(),
                        'Eat': $("#select2 #option2").text(),
                        'AttachFiles': link,
                        'Area': {
                            'ADR' : ADR,
                            'LOAD_ADR' : LOAD_ADR,
                            'LAT' : LAT,
                            'LNG' : LNG,
                            'NAME' : NAME,
                            'CUSTOM_NAME' : !!document.getElementById("mapname").value == "" ? 'null' : document.getElementById("mapname").value
                        }
                    }
                    $.ajax({
                        url:"/write/upload",
                        method:"POST",
                        data:json,
                        success: function(response){
                            console.log(response)
                            if(response == "OK"){
                                    location.href="/write/2"
                                    alert("업로드를 완료했습니다!")
                                }
                        }
                    })
                }else{
                    ADR = document.cookie.split("adr=")[1].split(";")[0].replace(" ","")
                    LAT = document.cookie.split("LAT=")[1].split(";")[0].replace(" ","")
                    LNG = document.cookie.split("LNG=")[1].split(";")[0].replace(" ","")
                    !!document.cookie.includes("road_adr=") ? LOAD_ADR = document.cookie.split("road_adr=")[1].split(";")[0].replace(" ","") : LOAD_ADR = 'null'
                    !!document.cookie.includes("name=") ? NAME = document.cookie.split("name=")[1].split(";")[0].replace(" ","") : NAME = 'null'

                        json = {
                            'Author':id,
                            'Name': document.getElementById("title").value,
                            'Desc': document.getElementById("textarea").value,
                            'People_meet': "None",
                            'Feel': $("#select #option").text(),
                            'Eat': $("#select2 #option2").text(),
                            'AttachFiles': link,
                            'Area': {
                                'ADR' : ADR,
                                'LOAD_ADR' : LOAD_ADR,
                                'LAT' : LAT,
                                'LNG' : LNG,
                                'NAME' : NAME,
                                'CUSTOM_NAME' : !!document.getElementById("mapname").value == "" ? 'null' : document.getElementById("mapname").value
                            }
                        }
                        $.ajax({
                            url:"/write/upload",
                            method:"POST",
                            data:json,
                            success: function(response){
                                if(response == "OK"){
                                    location.href="/write/2"
                                    alert("업로드를 완료했습니다!")
                                }
                            }
                        })
                             
            }
            uploading = false
        }
        
    }
        
    }

    function compare(a, b) {
        return a-b
    }


    function getFeelPercent(){
        $.ajax({
            url:"/Write",
            method:"POST",
            data:{
                "Author":id
            },
            success: function(response){
                let great = 0
                let good = 0
                let medium = 0
                let bad = 0
                let too_bad = 0
                let total = 0
                response.forEach(element => {
                    feel = element.Feel
                    if(feel == "맑음"){
                        great += 1
                    }
                    if(feel == "흐림"){
                        medium += 1
                    }
                    if(feel == "비"){
                        medium += 1
                    }                    
                    if(feel == "눈"){
                        bad += 1
                    }
                    if(feel == "바람"){
                        too_bad += 1
                    }
                });
                total = great+good+medium+bad+too_bad
                let greatper = (great / total * 100)
                let goodper = (good / total * 100)
                let mediumper = (medium / total * 100)
                let badper = (bad / total * 100)
                let too_badper = (too_bad / total * 100)

                const per = [greatper,goodper,mediumper,badper,too_badper];
                per.sort(function(a,b) {
                    return b-a;
                })
                let top = []
                per.forEach(element => {
                    if(greatper == element){
                        data = {
                            "name":"맑음",
                            "value":element
                        }
                        top.push(data)
                    }

                    if(goodper == element){
                        data = {
                            "name":"흐림",
                            "value":element
                        }
                        top.push(data)
                    }

                    if(mediumper == element){
                        data = {
                            "name":"비",
                            "value":element
                        }
                        top.push(data)
                    }

                    if(badper == element){
                        data = {
                            "name":"눈",
                            "value":element
                        }
                        top.push(data)
                    }

                    if(too_badper == element){
                        data = {
                            "name":"바람",
                            "value":element
                        }
                        top.push(data)
                    }
                });

                console.log(top)
                return top
            }
        });
    }

    function getPlacePercent(){
        $.ajax({
            url:"/Write",
            method:"POST",
            data:{
                "Author":id
            },
            success: function(response){
                const result = {};
                response.forEach(element => {
                    adr = element.AREA_ADR
                    result[adr] = (result[adr] || 0)+1; 
                })

                
                let per = []
                let resmap = new Map(Object.entries(result))
                const mapSort1 = new Map([...resmap.entries()].sort((a, b) => b[1] - a[1]));
                let max = 0

                mapSort1.forEach(element => {
                    max += element
                })

                mapSort1.forEach(element => {
                    percent = element/max * 100
                    per.push(percent)
                })

                let keyarr = Array.from(mapSort1.keys())
                let permap = []
                for(var i = 0; i < keyarr.length; i++){
                    permap.push({'name':keyarr[i], 'per':per[i]})
                }

                return permap
                    
                

            }
        })        
    }

    function getPersonPercent() {
        $.ajax({
            url:"/Write",
            method:"POST",
            data:{
                "Author":id
            },
            success: function(response){
                const result = {};
                response.forEach(element => {
                    peo = element.People_meet

                    if(peo.includes(""))
                    result[peo] = (result[peo] || 0)+1; 
                })

                
                let per = []
                let resmap = new Map(Object.entries(result))
                const mapSort1 = new Map([...resmap.entries()].sort((a, b) => b[1] - a[1]));
                let max = 0

                mapSort1.forEach(element => {
                    max += element
                })

                mapSort1.forEach(element => {
                    percent = element/max * 100
                    per.push(percent)
                })

                let keyarr = Array.from(mapSort1.keys())
                let permap = []
                for(var i = 0; i < keyarr.length; i++){
                    permap.push({'name':keyarr[i], 'per':per[i]})
                }

                return permap
                    
                

            }
        })           
    }


    function addCard(Date, Name, UserName, Ex) {
        card = Card(Date, Name, UserName, Ex)
        $("#write_main").prepend(card)
    }

    function Card(Date, Name, UserName, Ex) {
    return `<a href="/Record?detail">
                <div class="write_box">
                    <div>
                        <h2>${Date}</h2>
                        <p>${Name}</p>
                    </div>
                    <div class="user_info">
                        <p>${UserName}</p>
                        <p>${Ex}</p>
                    </div>
                </div>
            </a>`
}
</script>
<body>
        <!-- 헤더 시작 -->
        <header class="header">
            <div class="top_align">
                <!-- 네비 시작 -->
                <nav>
                    <ul>
                        <li><a href="/map">지도보기</a></li>
                        <li><a href="/write/1">기록하기</a></li>
                        <li><a href="/rank">랭킹보기</a></li>
                        <li><a href="/Mypage">마이페이지</a></li>
                    </ul>
                </nav>
                <!-- 네비 끝 -->
                <!-- 로고 시작 -->
                <div class="top_logo">
                    <div class="simbol">
                        <i class="fa-solid fa-house-user"></i>
                    </div>
                    <a href="/"><h1>DAILY LOG</h1></a>
                    <!-- 모바일용 햄버거 -->
                    <a href="#" class="nav_toogleBT">
                        <i class="fa-solid fa-bars"></i>
                    </a>
                </div>
                <!-- 아이콘 시작 -->
                <div class="top_icon">
                    <img src="../static/assets/like2.png" alt="메뉴의 좋아요 아이콘">
                    <img src="../static/assets/mypage2.png" alt="메뉴의 마이페이지 아이콘">
                </div>
                <!-- 아이콘 끝 -->
            </div>
        </header>
        <!-- 헤더 끝 -->
    <!-- 헤더 끝 -->

    <!-- 메인 시작 -->
    <main id="main">
        <section class="write_wrap">
            <div class="write_section">
                <div class="write_sub">
                    <div>
                        <h2>오늘의 하루</h2>
                    </div>
                    <div>
                        <input type="text" id="title" placeholder="제목">
                    </div>
                    <div>
                        <input onclick="openMap()" type="text" id="maps" placeholder="지역" readonly>
                    </div>
                    <div>
                        <input type="text" id="mapname" placeholder="커스텀 장소이름">
                    </div>
                    <div>
                        <input type="text" id="todayuser" placeholder="오늘 만난 사람">
                    </div>
                    <div class="select_box">
                        <div class="write_select">
                            <div id="select" class="select">
                                <strong></strong>
                                <div id="option">오늘의 기분</div>
                                <ul>
                                    <li data-option="맑음">맑음</li>
                                    <li data-option="흐림">흐림</li>
                                    <li data-option="비">비</li>
                                    <li data-option="눈">눈</li>
                                    <li data-option="바람">바람</li>
                                </ul>
                            </div>
                        </div>
                        <div class="write_select2">
                            <div id="select2" class="select2">
                                <div id="option2">오늘의 메뉴</div>
                                <ul>
                                    <li data-option="한식">한식</li>
                                    <li data-option="일식">일식</li>
                                    <li data-option="중식">중식</li>
                                    <li data-option="양식">양식</li>
                                    <li data-option="편의점">편의점</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div>
                        <input type="file">
                    </div>
                    <div>
                        <textarea id="textarea" rows=20 cols=45 placeholder="오늘 있었던 일 적기"></textarea>
                    </div>
                    <div>
                        <button type="reset">
                            취소
                        </button>
                        <button onclick="upload()" type="submit">
                            글쓰기
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </section>
    </main>
    <!-- 메인 끝 -->

    <!-- 푸터 시작 -->
    <footer class="footer">
        <div class="bottom_wrap">
            <div class="bottom_simbol">
                <i class="fa-solid fa-house-user"></i>
            </div>
            <div class="bottom_info">
                <span>Copyright 2022 . DAILYLOG . All Rights Reserved .</span>
                <span>전체서비스 이용약관 개인정보처리방침 통합검색 고객센터 © DAILY LOG</span>
            </div>
        </div>
    </footer>
    <!-- 푸터 끝 -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="../static/js/write.js"></script>
</body>

</html>