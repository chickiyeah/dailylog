<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/reset.css">
    <link rel="stylesheet" href="../static/css/header2.css">
    <link rel="stylesheet" href="../static/css/write2(update)style.css">
    <!-- 파비콘 -->
    <link rel="shortcut icon" href="./static/assets/house.svg" type="image/x-icon">
    <link rel="icon" href="./static/assets/house.svg" type="image/x-icon">
    <!-- 스크립트 -->
    <script src="./static/js/index.js" defer></script>

    <title>DAILY LOG</title>
    <script src="https://kit.fontawesome.com/80a9730165.js" crossorigin="anonymous"></script>

    

</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        let link = ""
        let postid = ""
        if(location.href.includes("?")){
            postid = location.href.split("?")[1].split("postid=")[1]
        }else{
            location.href = `/`;
            alert("표시할 글의 아이디가 지정되어있지 않습니다.\n카드에서 다시 클릭해보세요.\n홈으로 이동합니다.")
        }
        if(document.cookie.includes("id=")){
            login = true
            if(document.cookie.split("id=")[1].includes(";")){
                id = document.cookie.split("id=")[1].split(";")[0].replace(" ","")
            }else{
                id = document.cookie.split("id=")[1].replace(" ","")
            }
            let userinfo = ""
            $.ajax({
                url:"/User",
                method:"POST",
                data:{
                    id:id
                },
                success: function(response){
                    name = response.nickname
                                //목록 가져오기
                    $.ajax({
                        url:"/Write",
                        method:"POST",
                        data:{
                            "Author":id
                        },
                        success: function(response){
                            response.forEach(element => {
                                let now = new Date()

                                let year = now.getFullYear()
                                let month = now.getMonth()
                                let day = now.getDate()
                                let hours = now.getHours()+9
                                let minutes = now.getMinutes()
                                let seconds = now.getSeconds()

                                let nowdate = new Date(year, month, day, hours, minutes, seconds)

                                let chai = nowdate.getTime() - new Date(element.Created_At).getTime()
                                let a = ""

                                let wmon = element.Created_At.split("-")[1]
                                let wday = element.Created_At.split("-")[2].split("T")[0]

                                if(chai < 1000 * 60)
                                    a += '방금'
                                else if(chai < 1000 * 60 * 60)
                                    a += Math.floor(chai / (1000 * 60)) + '분 전';
                                else if(chai < 1000 * 60 * 60 * 24)
                                    a += Math.floor(chai / (1000 * 60 * 60)) + '시간 전';
                                else if(chai < 1000 * 60 * 60 * 24 * 30)
                                    a += Math.floor(chai / (1000 * 60 * 60 * 24)) + '일 전';
                                else if(chai < 1000 * 60 * 60 * 24 * 30 * 12)
                                    a += Math.floor(chai / (1000 * 60 * 60 * 24 * 30)) + '달 전';
                                else
                                    a += Math.floor(chai / (1000 * 60 * 60 * 24 * 30 * 12)) + '년 전';
                                

                                if(postid == element.Created_At) {
                                    document.getElementById("title").value = element.Name
                                    document.getElementById("textarea").value = element.Description
                                    document.getElementById("todayuser").value = element.People_meet
                                    $("#select #option").text(element.Feel)
                                    $("#select2 #option2").text(element.Eat)
                                    if(element.AttachFiles == "null" || element.AttachFiles == ""){
                                        $("#file").append("<span>이미지를 업로드하면 원래 이미지를 덮어쓰게됩니다. 현재이미지 없음</span>")
                                    }else{
                                        $("#file").append(`<span>이미지를 업로드하면 원래 이미지를 덮어쓰게됩니다. 현재이미지 <a style="color:blue;" href="${element.AttachFiles}">클릭</a></span>`)
                                    }
                                }
                            });
                        }
                    })
                }
            })

        }else{
            if(location.href.includes("?")){
                loc = location.href.split("?")[1].split("postid=")[1]
                location.href = `/Login?loc = write/detail?postid=${loc}`
            }else{
                location.href = `/Login?loc = `;
            } 
            login = false
            alert("로그인이 필요합니다.")
        }
    })

    function addCard(Date, Name, UserName, Ex) {
        card = Card(Date, Name, UserName, Ex)
        $("#write_main").prepend(card)
    }

    function Card(Date, Name, UserName, link,  Ex) {
    return `<a href="/Record?${link}">
                <div class="write_box">
                    <div>
                        <h2>${Date}</h2>
                        <p>${Name}</p>
                    </div>
                    <div class="user_info">
                        <p>${UserName}</p>
                        <p>${Ex}</p>
                    </div>
                </div>
            </a>`
}
</script>
<body>
    <!-- 헤더 시작 -->
    <header class="header">
        <div class="top_align">
            <!-- 네비 시작 -->
            <nav>
                <ul>
                    <li><a href="/map">지도보기</a></li>
                    <li><a href="/write/1">기록하기</a></li>
                    <li><a href="/rank">랭킹보기</a></li>
                    <li><a href="/Mypage">마이페이지</a></li>
                </ul>
            </nav>
            <!-- 네비 끝 -->
            <!-- 로고 시작 -->
            <div class="top_logo">
                <div class="simbol">
                    <i class="fa-solid fa-house-user"></i>
                </div>
                <a href="/"><h1>DAILY LOG</h1></a>
                <!-- 모바일용 햄버거 -->
                <a href="#" class="nav_toogleBT">
                    <i class="fa-solid fa-bars"></i>
                </a>
            </div>
            <!-- 아이콘 시작 -->
            <div class="top_icon">
                    <a onclick="location.href='/Mypage/Like'"><img src="../static/assets/like.png" alt="메뉴의 좋아요 아이콘"></a>
                    <a href="/Mypage"><img src="../static/assets/mypage.png" alt="메뉴의 마이페이지 아이콘"></a>
            </div>
            <!-- 아이콘 끝 -->
        </div>
    </header>
    <!-- 헤더 끝 -->
<!-- 헤더 끝 -->

<!-- 메인 시작 -->
<main id="main">
    <section class="write_wrap">
        <div class="write_section">
            <div class="write_sub">
                <div>
                    <h2>오늘의 하루</h2>
                </div>
                <div>
                    <input type="text" id="title" placeholder="제목">
                </div>
                <div>
                    <input onclick="openMap()" type="text" id="maps" placeholder="지역" readonly>
                </div>
                <div>
                    <input type="text" id="mapname" placeholder="커스텀 장소이름">
                </div>
                <div>
                    <input type="text" id="todayuser" placeholder="오늘 만난 사람">
                </div>
                <div class="select_box">
                    <div class="write_select">
                        <div id="select" class="select">
                            <strong></strong>
                            <div id="option">오늘의 기분</div>
                            <ul>
                                <li data-option="맑음">맑음</li>
                                <li data-option="흐림">흐림</li>
                                <li data-option="비">비</li>
                                <li data-option="눈">눈</li>
                                <li data-option="바람">바람</li>
                            </ul>
                        </div>
                    </div>
                    <div class="write_select2">
                        <div id="select2" class="select2">
                            <div id="option2">오늘의 메뉴</div>
                            <ul>
                                <li data-option="한식">한식</li>
                                <li data-option="일식">일식</li>
                                <li data-option="중식">중식</li>
                                <li data-option="양식">양식</li>
                                <li data-option="편의점">편의점</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="file">
                    <form action = '/UploadFile' method = "POST" entype = "multipart/form-data">
                        <input type="file" name="file" id="input">
                    </form>  
                    
                </div>
                <div>
                    <textarea id="textarea" rows=20 cols=45 placeholder="오늘 있었던 일 적기"></textarea>
                </div>
                <div>
                    <button type="reset">
                        취소
                    </button>
                    <button onclick="upload()" type="submit">
                        수정
                    </button>
                </div>
            </div>
        </div>
        </div>
    </section>
</main>
<!-- 메인 끝 -->

<!-- 푸터 시작 -->
<footer class="footer">
    <div class="bottom_wrap">
        <div class="bottom_simbol">
            <i class="fa-solid fa-house-user"></i>
        </div>
        <div class="bottom_info">
            <span>Copyright 2022 . DAILYLOG . All Rights Reserved .</span>
            <span>전체서비스 이용약관 개인정보처리방침 통합검색 고객센터 © DAILY LOG</span>
        </div>
    </div>
</footer>
<!-- 푸터 끝 -->
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
    integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script src="../static/js/write.js"></script>
    <script>
        const inputElement = document.getElementById("input").addEventListener("change", handleFiles)

        function handleFiles() {
            const filelist = this.files
            for (let i = 0, numFiles = filelist.length; i < numFiles; i++){
                let file = filelist[i]
                let formdata = new FormData()
                formdata.append('File', file)
                    let xhr = new XMLHttpRequest();
                    xhr.open('POST', '/UploadFile' ,true)
                    xhr.onload = xhr.onerror = function() {
                        link = xhr.responseText
                        image = `<img src="${xhr.responseText}">`
                        console.log(image)
                        $("#textarea").append(image)
                    };
                    xhr.send(formdata)
            }
        }
    </script>
</body>

</html>